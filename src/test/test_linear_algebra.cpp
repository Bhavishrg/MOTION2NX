// MIT License
//
// Copyright (c) 2020 Lennart Braun
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in all
// copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.

#include <gtest/gtest.h>
#include <cstdint>
#include "tensor/tensor_op.h"
#include "utility/linear_algebra.h"

class Conv2DTest : public ::testing::Test {
 protected:
  static const MOTION::tensor::Conv2DOp conv_op_;
  static const std::vector<std::uint16_t> input_buffer_;
  static const std::vector<std::uint16_t> kernel_buffer_;
  static const std::vector<std::uint16_t> expected_output_buffer_;
};

// Convolution from CryptoNets
const MOTION::tensor::Conv2DOp Conv2DTest::conv_op_ = {.kernel_shape_ = {5, 1, 5, 5},
                                                       .input_shape_ = {1, 28, 28},
                                                       .output_shape_ = {5, 13, 13},
                                                       .dilations_ = {1, 1},
                                                       .pads_ = {1, 1, 0, 0},
                                                       .strides_ = {2, 2}};

const std::vector<std::uint16_t> Conv2DTest::input_buffer_ = {
    56422, 24545, 15795, 52202, 860,   62306, 38158, 12021, 62570, 47971, 54343, 51097, 44732,
    39233, 11284, 39115, 54886, 10224, 6265,  29218, 16850, 10223, 62678, 6551,  37194, 3806,
    21962, 30097, 47191, 56765, 60788, 21869, 44131, 39394, 60263, 9362,  16023, 46404, 41090,
    42656, 1685,  1349,  64820, 3696,  769,   63564, 59735, 47316, 62955, 54554, 64925, 61508,
    56101, 13915, 2433,  51,    5311,  11916, 37819, 65025, 39188, 12019, 17568, 40467, 53707,
    19938, 19769, 40085, 28693, 34390, 6396,  463,   62187, 28307, 27480, 1511,  65072, 19085,
    41434, 34391, 25658, 40098, 18942, 26205, 57001, 9141,  18431, 3058,  64987, 19145, 2747,
    63816, 58319, 24009, 59150, 15254, 189,   29889, 64445, 5937,  19118, 51457, 35773, 40526,
    53810, 13085, 1899,  25065, 56886, 33700, 1267,  64437, 31551, 38824, 50680, 30589, 11394,
    3044,  3556,  56357, 3890,  39816, 41606, 44584, 30740, 11175, 60232, 29523, 14502, 4263,
    21777, 869,   10627, 62186, 8792,  61748, 43323, 63283, 43021, 36915, 8433,  52979, 43001,
    25258, 11016, 19963, 23897, 1046,  2612,  6401,  56193, 15131, 58707, 44841, 55387, 15795,
    54638, 28845, 23483, 44778, 58822, 7997,  48555, 39976, 59900, 32451, 17159, 54604, 44974,
    2253,  40994, 11361, 14541, 59593, 35920, 25628, 26531, 16959, 1585,  11943, 3943,  43419,
    23939, 49503, 19457, 20428, 1021,  27863, 11653, 34083, 43573, 13627, 13417, 35829, 52995,
    37204, 40757, 12114, 9692,  2052,  45758, 63542, 63889, 55199, 6873,  50799, 5675,  29475,
    161,   61571, 37065, 25896, 26557, 58643, 33763, 60729, 63757, 39183, 32606, 47662, 62255,
    60415, 11534, 21400, 29127, 5799,  40397, 37384, 61142, 12843, 25851, 34133, 1016,  2964,
    24253, 62991, 55591, 21320, 24276, 55347, 23247, 25472, 24300, 48976, 8529,  17783, 17262,
    35369, 9268,  54312, 21271, 38453, 12185, 23380, 63704, 63258, 21243, 18411, 39099, 39782,
    8571,  35566, 57836, 18087, 39976, 9235,  38044, 19416, 51214, 52572, 61228, 10830, 49216,
    4885,  48984, 1024,  40774, 64676, 2568,  27748, 54615, 50609, 62592, 25878, 2027,  13023,
    2695,  19234, 58839, 361,   48190, 922,   5258,  53442, 22002, 13031, 39504, 46324, 33159,
    46618, 13986, 47776, 61858, 51784, 63776, 50545, 12666, 39712, 38660, 4852,  3561,  60706,
    26854, 23492, 64505, 42668, 38952, 7593,  52251, 59962, 22662, 56564, 8392,  55708, 30535,
    40848, 13067, 29455, 48033, 21685, 52256, 6252,  23599, 4165,  61942, 24301, 35222, 20380,
    11837, 43833, 14039, 21311, 58148, 43641, 30818, 47815, 19115, 38751, 63335, 41782, 10965,
    18004, 24538, 58144, 42530, 36781, 5056,  30947, 32482, 25095, 47716, 7837,  8110,  63682,
    13773, 46743, 27266, 55634, 52992, 49858, 17412, 47299, 56537, 36783, 33270, 15465, 6910,
    50526, 45453, 16781, 25446, 32361, 56090, 2649,  53640, 34257, 206,   46574, 21518, 28019,
    22361, 7267,  56873, 1665,  23419, 28792, 50636, 7070,  57010, 13219, 48702, 2059,  50015,
    58704, 51942, 41707, 56560, 31153, 41523, 20601, 54268, 36914, 45151, 33329, 22403, 45581,
    18141, 59478, 14820, 9131,  40342, 16337, 6374,  39611, 56044, 26894, 1678,  35379, 52394,
    49515, 53788, 13307, 33827, 14994, 55820, 61790, 62623, 5044,  16198, 39247, 9914,  18989,
    27890, 45533, 52309, 10565, 22299, 57702, 43585, 60928, 43689, 40917, 64044, 52960, 42557,
    19374, 49080, 41510, 44020, 6913,  2693,  57112, 29467, 29919, 29723, 52669, 46699, 14315,
    3627,  12227, 25939, 27296, 48925, 58494, 42941, 57886, 21834, 35346, 18047, 21256, 26105,
    52916, 10230, 8001,  15707, 58726, 21976, 23350, 44262, 20840, 59581, 59429, 23776, 7212,
    30080, 17834, 62840, 14937, 1306,  42447, 61373, 27990, 6776,  34,    27251, 53609, 62412,
    23105, 55016, 56408, 9474,  19974, 40294, 455,   58053, 10790, 21959, 33472, 5530,  35002,
    29320, 27355, 53565, 31773, 3748,  14556, 31968, 45379, 32562, 7855,  13545, 17656, 62123,
    22125, 663,   15999, 34766, 61794, 7994,  11029, 28021, 21181, 61087, 14336, 30303, 33999,
    50647, 36575, 3304,  46073, 52915, 26465, 54384, 23830, 51005, 4252,  46576, 63686, 39353,
    16640, 62003, 63074, 17675, 16179, 52733, 16500, 65318, 45632, 44417, 32587, 23938, 46679,
    23664, 19718, 1636,  9705,  20080, 18667, 60343, 65387, 27728, 2417,  49850, 17483, 26736,
    39948, 28673, 64003, 37505, 32943, 47323, 26937, 46645, 3373,  854,   2166,  24548, 18261,
    38623, 22614, 7392,  59524, 55680, 41572, 60818, 15699, 46717, 44610, 54401, 9495,  21556,
    34795, 50859, 32076, 60121, 29345, 38559, 64595, 26309, 36234, 21919, 15863, 63734, 38842,
    4931,  44049, 52662, 5298,  32970, 49913, 44215, 24225, 53370, 15573, 12688, 15870, 25342,
    47724, 37157, 52634, 2327,  24103, 40772, 30821, 52083, 41438, 40545, 64449, 197,   41519,
    23509, 26137, 34698, 35112, 44542, 53505, 15087, 5917,  22671, 52320, 25184, 54742, 27848,
    9877,  42107, 21022, 20666, 33305, 44357, 12223, 51663, 45600, 15708, 2672,  26370, 56253,
    49811, 38724, 2811,  21362, 56250, 44404, 47011, 14433, 6546,  1087,  58713, 46605, 34754,
    33560, 30206, 53051, 41106, 14843, 11411, 22850, 2911,  42282, 1734,  6303,  18227, 11427,
    8680,  61638, 19360, 45281, 18343, 26055, 5759,  25345, 23078, 33931, 35153, 61389, 11111,
    54900, 37504, 9012,  1802,  44282, 8155,  22352, 8120,  48183, 39384, 7436,  47025, 13701,
    47254, 60600, 21918, 35484, 20445, 57497, 60713, 45598, 30306, 16904, 16646, 14978, 46843,
    43252, 55439, 11465, 31065, 53557, 25199, 64367, 41976, 36385, 16371, 33858, 11835, 34711,
    45936, 17093, 2049,  15850, 31616, 65290, 38191, 6101,  47357, 63269, 61067, 58799, 20932,
    36588, 52260, 59009, 29855, 57844, 61434, 41490, 7158,  12367, 43016, 22218, 7400,  18276,
    52322, 22885, 42642, 45898};

const std::vector<std::uint16_t> Conv2DTest::kernel_buffer_ = {
    15151, 47576, 51407, 55486, 1154,  58793, 4499,  56120, 6295,  58136, 55349, 26509, 60535,
    51109, 59040, 58180, 12183, 42076, 29299, 55766, 12874, 5514,  50800, 61317, 32711, 10592,
    5539,  51468, 42405, 58887, 53351, 43842, 61267, 39742, 57597, 38055, 48354, 602,   60527,
    24397, 2557,  6650,  38360, 61612, 16482, 43483, 2200,  63810, 46940, 331,   2961,  18607,
    46975, 10538, 21357, 20012, 53585, 35961, 11969, 31825, 2869,  45344, 60578, 29387, 61135,
    42726, 50108, 65172, 46760, 14697, 28643, 11529, 24736, 46673, 38467, 1184,  23328, 15548,
    53645, 32367, 25876, 21325, 21295, 11719, 3987,  48922, 58871, 24016, 22399, 42574, 62855,
    48769, 46214, 55654, 33986, 47247, 20880, 43097, 4735,  20189, 44064, 37244, 60079, 35555,
    4555,  6139,  41914, 33345, 40818, 24098, 45525, 41702, 19830, 17380, 17429, 16414, 6893,
    15990, 50845, 38657, 14373, 63767, 47333, 64152, 3436};

const std::vector<std::uint16_t> Conv2DTest::expected_output_buffer_ = {
    52396, 5978,  39672, 37991, 61095, 16079, 65244, 9781,  58512, 60354, 8626,  57769, 38604,
    29278, 14509, 31434, 31230, 31963, 6500,  5892,  45536, 13627, 34704, 24031, 51928, 14195,
    12793, 28188, 24543, 13470, 5684,  14769, 28314, 26258, 12543, 62488, 25481, 62347, 667,
    44366, 55558, 58054, 14970, 26637, 59628, 46912, 61455, 17891, 26223, 53768, 37258, 25045,
    62155, 19886, 26649, 42067, 29181, 26835, 3918,  62932, 30846, 30338, 5750,  9939,  44664,
    63811, 49651, 9010,  41117, 49835, 20098, 63534, 20936, 56695, 48381, 31184, 27254, 9838,
    40666, 16618, 56067, 13336, 48530, 32820, 42989, 2671,  46906, 25937, 17300, 40109, 11362,
    7659,  58839, 28729, 692,   27600, 43258, 49361, 28452, 25449, 2218,  17281, 22900, 43371,
    48579, 1257,  12961, 44782, 35928, 11803, 17542, 6671,  53327, 281,   30727, 14490, 5874,
    62554, 26180, 65231, 23757, 58612, 25916, 11488, 57889, 3099,  52386, 26199, 49550, 8579,
    38952, 48178, 48319, 52186, 34923, 55278, 1590,  2967,  16719, 64352, 8818,  38568, 51043,
    48323, 6206,  45129, 62679, 46409, 48549, 3939,  58571, 18338, 56991, 8402,  34818, 19841,
    56596, 41442, 2263,  28184, 32137, 41639, 34811, 19749, 2228,  10731, 1537,  38848, 11562,
    56680, 24347, 2864,  62146, 47280, 50281, 37741, 21834, 9154,  31607, 54607, 20220, 19945,
    53984, 49318, 60389, 49373, 50133, 56206, 12541, 48608, 16761, 26080, 47042, 62596, 52760,
    39518, 59751, 57857, 44406, 64234, 18993, 6990,  36118, 7292,  15038, 56710, 1767,  37004,
    48740, 30331, 49149, 18226, 54421, 18308, 42172, 34714, 22780, 60806, 56509, 22048, 1258,
    61256, 47033, 7943,  22603, 56234, 60811, 19579, 15981, 16866, 7028,  49784, 27199, 42758,
    16311, 29017, 35188, 36063, 51773, 60485, 52348, 4485,  16329, 4849,  21545, 24645, 46616,
    30819, 33712, 19339, 8804,  57425, 61722, 59609, 47363, 56916, 47349, 59627, 10220, 37186,
    53865, 33394, 16340, 31723, 29219, 53222, 52831, 14800, 36078, 16566, 4730,  29678, 657,
    57582, 42572, 40656, 4689,  29258, 12833, 56526, 4953,  14150, 25851, 22092, 59053, 35992,
    23256, 53761, 19849, 50408, 40036, 7968,  38143, 10979, 40548, 9587,  16937, 41167, 5017,
    59569, 5697,  5717,  46399, 62061, 16838, 28832, 12227, 10254, 46688, 53617, 32318, 17857,
    37236, 20759, 45517, 50864, 3800,  44463, 7450,  37611, 18003, 3495,  6328,  10297, 44725,
    55210, 53671, 14453, 7519,  61177, 20577, 2213,  42547, 11311, 21401, 20471, 23749, 51118,
    38048, 55352, 60466, 14775, 37051, 45442, 20790, 15725, 8151,  52467, 51328, 2519,  19915,
    44330, 535,   53495, 43557, 44974, 8134,  45877, 26360, 52073, 44390, 47668, 32410, 29883,
    64519, 21679, 43918, 3312,  62927, 87,    26400, 50806, 47017, 21693, 62121, 49603, 43064,
    35209, 50491, 18856, 15618, 50158, 10286, 31982, 46353, 35829, 9576,  46755, 53287, 39831,
    57543, 7800,  27528, 60680, 27706, 31542, 15851, 63861, 47431, 57002, 8068,  45712, 33552,
    57986, 58821, 63094, 29907, 47801, 21140, 56302, 21373, 58258, 45297, 43050, 42940, 17522,
    60035, 60105, 14643, 13608, 54502, 50143, 1104,  22,    22011, 30707, 46817, 18999, 33436,
    29866, 64873, 21422, 1230,  58403, 14258, 11464, 38019, 12864, 48984, 37143, 49116, 5620,
    24988, 16677, 44888, 7021,  4276,  30258, 55884, 4228,  43547, 57113, 31202, 15995, 45029,
    15177, 3125,  50222, 31287, 51468, 62135, 13675, 18163, 49667, 21621, 25280, 56890, 27108,
    47347, 56485, 29064, 30123, 8409,  64502, 4614,  39360, 20744, 13642, 36537, 26143, 53445,
    13260, 55019, 58370, 14497, 40331, 35477, 61737, 32453, 46808, 24408, 9994,  53043, 46110,
    3684,  60854, 58505, 57933, 48686, 59362, 32108, 60876, 37736, 41525, 25847, 55660, 10345,
    37622, 604,   58734, 12096, 17271, 8200,  3392,  22107, 46428, 36829, 4956,  64664, 15131,
    12755, 1202,  9962,  14975, 25018, 34622, 9206,  42779, 61645, 43512, 24166, 47926, 36431,
    39429, 9847,  24901, 20904, 34734, 12633, 51429, 45527, 39284, 33566, 44396, 34884, 44808,
    29173, 7096,  35262, 4373,  16204, 62639, 65232, 7169,  49102, 51202, 52868, 23258, 56702,
    22872, 48798, 36849, 10229, 21150, 6923,  58603, 6479,  20514, 25890, 17169, 50690, 37306,
    42942, 15761, 58310, 38583, 65014, 21172, 29100, 43219, 22384, 17799, 12400, 14337, 9680,
    6739,  54578, 8176,  18212, 3401,  50236, 8380,  57517, 38822, 20301, 6776,  60974, 63540,
    58655, 37867, 31080, 44351, 24910, 59709, 50359, 39591, 50421, 38070, 41462, 42008, 58188,
    3525,  35801, 25304, 34602, 42534, 23080, 58880, 49887, 30621, 17403, 8827,  2171,  1234,
    42776, 30232, 37895, 24871, 57783, 22622, 21424, 43165, 50091, 57555, 48326, 24898, 32113,
    49850, 3838,  20552, 3387,  49430, 49594, 24576, 16938, 51148, 30436, 54710, 31494, 29365,
    50960, 23019, 61737, 14129, 50582, 25671, 63695, 55760, 44019, 12588, 63795, 13936, 10281,
    47620, 9152,  59149, 35831, 13532, 29462, 34729, 44819, 3591,  48071, 63030, 61309, 13064,
    10803, 23824, 42534, 10356, 56311, 37022, 64094, 48616, 60071, 29605, 33007, 52012, 23502,
    27780, 17763, 51553, 55317, 44130, 13111, 23633, 808,   45140, 48235, 3164,  42527, 1332,
    16268, 43633, 17276, 46231, 1723,  65294, 1942,  17066, 53716, 15805, 50858, 23167, 22381,
    64688, 39025, 39253, 13122, 54757, 41432, 13392, 15814, 58709, 45472, 15710, 10064, 32326,
    23816, 51601, 26867, 46232, 40999, 45815, 16501, 1020,  22790, 16213, 3175,  16175, 47796,
    18381, 5627,  53051, 243,   42033, 56992, 18296, 59812, 40463, 62809, 35743, 1682,  22609,
    57632, 46637, 59996, 34658, 6417,  14743, 5132,  53128, 50440, 43497, 16279, 56640, 64192,
    38794, 18788, 25021, 46985, 35033, 23478, 45285, 35629, 25039, 46061, 29067, 31551, 11661,
    18792, 28051, 58974, 59616, 41461, 32531, 50771, 58372, 33814, 37759, 31851, 38299, 49140,
    29470, 58889, 14150, 386,   15799, 10829, 57678, 8864,  30536, 1268,  17889, 37001, 42724,
    52885, 48133, 9717,  31266, 52049, 40407, 5629,  21972, 28547, 56332, 53279, 8197,  11801,
    32118, 57303, 10369, 54965, 13936, 51584, 43231, 13841, 27664, 26370, 13024, 24978, 31423,
    44141, 43406, 39071, 48237, 23292, 64748, 26621, 65314, 47623, 61578, 63806, 17925, 51087};

TEST_F(Conv2DTest, Conv2D) {
  ASSERT_TRUE(conv_op_.verify());
  auto output_buffer = MOTION::convolution(conv_op_, input_buffer_, kernel_buffer_);
  ASSERT_EQ(output_buffer, expected_output_buffer_);
}
